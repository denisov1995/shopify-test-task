(()=>{"use strict";class t{constructor(){return t.instance||(this.initialized=!1,t.instance=this),t.instance}init(){this.initialized||(this.setupEventListeners(),this.initialized=!0)}setupEventListeners(){document.addEventListener("submit",(async t=>{t.target.classList.contains("product-form")&&(t.preventDefault(),await this.addToCart(new FormData(t.target)))})),document.addEventListener("click",(async t=>{if(t.target.classList.contains("cart-item__remove")){t.preventDefault();const e=t.target.closest(".cart-item");await this.removeItem(e.dataset.id)}if(t.target.closest(".cart-item__quantity")){const e=t.target.closest(".cart-item__quantity").querySelector("input"),a=t.target.closest(".cart-item").dataset.id,s=parseInt(e.value),r=t.target.classList.contains("plus"),n=t.target.classList.contains("minus");if(!r&&!n)return;let c=s+(r?1:-1);c=Math.max(0,c),e.value=c,console.log("newQuantity",c);try{0===c?await this.removeItem(a):await this.updateItem(a,c)}catch(t){console.error("Ошибка обновления корзины:",t),e.value=s,this.showError("Не удалось обновить корзину")}}}))}async updateCartSection(){try{const t=await fetch("/?section_id=sidebar-cart"),e=await t.text(),a=document.createElement("div");a.innerHTML=e;const s=document.getElementById("sidebar-cart");s&&(s.innerHTML=a.querySelector("#sidebar-cart").innerHTML),this.updateCartCount()}catch(t){console.error("Cart update error:",t)}}async updateCartCount(){try{const t=await fetch("/cart.js"),e=await t.json();document.querySelectorAll(".cart-count-bubble, .header-cart-count").forEach((t=>{t.textContent=e.item_count}))}catch(t){console.error("Cart count update error:",t)}}async changeItem(t){try{const e=await fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({updates:t})}),a=await e.json();await this.updateCartSection(),console.log("Updated cart after deleted",a)}catch(t){console.error("Remove item failed:",t),alert("Failed to remove item. Please try again.")}}async addToCart(t){try{const e=await fetch("/cart/add.js",{method:"POST",body:t});await e.json(),await this.updateCartSection()}catch(t){console.error("Add to cart error:",t)}}async removeItem(t){const e={[t]:0};this.changeItem(e)}async updateItem(t,e){const a={[t]:e};this.changeItem(a)}showSidebar(){document.getElementById("sidebar-cart").classList.add("active"),document.body.classList.add("no-scroll")}hideSidebar(){document.getElementById("sidebar-cart").classList.remove("active"),document.body.classList.remove("no-scroll")}}document.addEventListener("DOMContentLoaded",(()=>{(new t).init()}))})();